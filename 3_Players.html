<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snooker Scoreboard (3 Players)</title>
    <style>
        /* Font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        /* Basic Body and HTML styling */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        body {
            background-color: #006400; /* Dark green for snooker table feel */
            color: white;
            font-family: 'Share Tech Mono', monospace;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 1.5vh 1.5vw;
            padding: 2.5vh 2.5vw;
            box-sizing: border-box;
            touch-action: manipulation;
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
        }

        body.darken-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

        /* Player containers - now using Flexbox for stable layout */
        .player-container {
            display: grid; /* Use grid for a more stable layout */
            grid-template-rows: auto 1fr; /* Row for name, and a flexible row for score */
            grid-template-columns: 1fr;
            
            border: 2px solid #555;
            border-radius: 10px;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 100%;
        }

        .player-container.active {
            border-color: #FFFF00;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
        }

        /* Unique background colors for each player in green tone */
        .player-container.player-a {
            grid-area: 1 / 1 / 2 / 2;
            background-color: rgba(144, 238, 144, 0.3); /* Light Green */
        }

        .player-container.player-b {
            grid-area: 1 / 2 / 2 / 3;
            background-color: rgba(60, 179, 113, 0.4); /* Medium Sea Green */
        }

        .player-container.player-c {
            grid-area: 2 / 1 / 3 / 2;
            background-color: rgba(0, 128, 0, 0.5); /* Green */
        }

        /* Name wrapper to hold player name and prevent its size from changing */
        .player-name-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            flex-shrink: 0;
            width: 100%;
        }

        .player-name {
            font-size: 5vmin;
            font-weight: bold;
            color: #FFFFFF;
            width: auto;
            border: none;
            background: none;
            outline: none;
            padding: 0;
            text-shadow:
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                0 0 10px #fff;
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease;
            margin-right: 10px;
            min-height: 5vmin;
        }

        .player-name.editing {
            color: #FF0000;
        }

        .player-frame-score {
            font-size: 7.5vmin;
            font-weight: bold;
            color: #FFFF00;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5), 0 0 5px #FFFF00;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: absolute;
            top: 5%;
            right: 5%;
            transform: translate(0, 0);
            z-index: 10;
        }
        
        .player-frame-score:active {
            transform: scale(0.95);
        }
        
        .player-score-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .player-score {
            font-size: 25vmin;
            font-weight: normal;
            text-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF;
            color: #00FFFF;
            line-height: 1;
            transition: font-size 0.2s ease, color 0.2s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap;
        }

        /* New class for negative scores */
        .player-score.negative-score {
            color: #F44336; /* red */
        }
        
        .player-score.three-digit {
            font-size: 15vmin;
        }

        /* Control container (bottom right) */
        .control-container {
            grid-area: 2 / 2 / 3 / 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #555;
            border-radius: 10px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap; 
        }

        .score-buttons-container {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .score-buttons-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .score-buttons-row > * {
            margin: 0 0.7vmin;
            min-width: 7.35vmin;
            min-height: 7.35vmin;
        }
        
        .snooker-ball {
            width: 10vmin;
            height: 10vmin;
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 4.5vmin;
            font-weight: bold;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            box-shadow:
                0 0 10px rgba(255, 255, 255, 0.2),
                0 8px 15px rgba(0, 0, 0, 0.6),
                inset 0 0 15px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px rgba(0, 0, 0, 0.5);
            position: relative;
            transform: translateY(0);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .snooker-ball:active {
            transform: translateY(2px);
            box-shadow:
                0 0 5px rgba(255, 255, 255, 0.1),
                0 4px 8px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .action-buttons-container {
            display: flex;
            justify-content: flex-start; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
            align-items: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            width: 100%;
            margin-top: 15px;
            /* ‡∏•‡∏ö gap ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ margin ‡πÅ‡∏ó‡∏ô */
        }
        
        .sign-button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }

        .action-button {
            color: #FFFFFF;
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
            border: none;
            cursor: pointer;
            width: 25%;
            height: 6vh;
            border-radius: 1vw;
            font-size: 2.5vmin;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            position: relative;
            transform: translateY(0);
            margin-right: 1.5vw; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
        }
        
        .action-button:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .action-button:active {
            transform: translateY(1px);
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .finish-button { background-color: #4CAF50; }
        .set-zero-button { background-color: #FF9800; }
        .undo-button { background-color: #F44336; }

        .sign-button {
            background-color: #0000FF; /* Blue color for inactive */
            color: white;
            border-radius: 8px;
            width: 36%;
            font-size: 4vmin;
            height: 8vh;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            font-weight: bold;
        }

        .sign-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .sign-button.active {
            background-color: #DC143C; /* Crimson/Dark Red for active/foul */
            box-shadow: 0 0 15px rgba(220, 20, 60, 0.8);
            transform: translateY(0);
        }
        
        /* Ball colors */
        .red { background-color: #FF0000; }
        .yellow { background-color: #FFFF00; color: black; }
        .green { background-color: #008000; }
        .brown { background-color: #A52A2A; }
        .blue { background-color: #0000FF; }
        .pink { background-color: #FFC0CB; color: black; }
        .black { background-color: #000000; }
        .gold-ball { background-color: #FFD700; color: black; }

        /* Home button style */
        .home-button {
            background-color: #FFD700;
            color: black;
            width: 6vh;
            height: 6vh;
            border-radius: 50%;
            font-size: 2.5vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0 0.5vw;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö margin-right ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Home ‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏•‡∏á 50% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏∏‡πà‡∏° CG */
        #home-button {
            margin-right: 0.75vw;
        }
        
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° CG ‡πÑ‡∏°‡πà‡∏°‡∏µ margin ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å */
        #cg-button {
            margin-right: 0;
        }

        .home-button.home-text { color: white; }
        
        .home-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
        }

        .home-button:active {
            transform: translateY(1px);
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }

        .message-box {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1vmin 2vmin;
            border-radius: 1vw;
            font-size: 2.5vmin;
            text-align: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 100;
        }
        
        .message-box.show {
            visibility: visible;
            opacity: 1;
        }
        
        /* Numeric keypad */
        .keypad-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        
        .keypad-container {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 400px;
        }
        
        .keypad-input {
            width: 100%;
            background-color: #444;
            color: white;
            border: none;
            text-align: right;
            font-size: 4vmin;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .keypad-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
        }
        
        .keypad-button {
            width: 100%;
            padding: 2vmin;
            font-size: 5vmin;
            font-family: 'Share Tech Mono', monospace;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        
        .keypad-button:active {
            background-color: #777;
        }

        .keypad-buttons-row-special {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }
        
        .keypad-button.special {
            width: 100%;
            padding: 2vmin;
            font-size: 4vmin;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .keypad-button.done { background-color: #4CAF50; color: white; }
        .keypad-button.backspace { background-color: #F44336; color: white; }
        .keypad-button.cancel { background-color: #FF9800; color: white; }
        
        /* Name input modal */
        .name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        
        .name-container {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 400px;
        }

        .name-input {
            width: 100%;
            background-color: #444;
            color: white;
            border: none;
            font-size: 4vmin;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .name-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .name-buttons > button {
            width: 50%;
            padding: 2vmin;
            font-size: 4vmin;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="player-container player-a" data-player-id="player-a">
        <div class="player-name-wrapper">
            <div class="player-name editable-name" id="player-a-name" data-player-id="player-a">PLAYER A</div>
        </div>
        <div class="player-frame-score editable-score" id="player-a-frames">0</div>
        <div class="player-score-wrapper">
            <div class="player-score" id="player-a-score">0</div>
        </div>
    </div>

    <div class="player-container player-b" data-player-id="player-b">
        <div class="player-name-wrapper">
            <div class="player-name editable-name" id="player-b-name" data-player-id="player-b">PLAYER B</div>
        </div>
        <div class="player-frame-score editable-score" id="player-b-frames">0</div>
        <div class="player-score-wrapper">
            <div class="player-score" id="player-b-score">0</div>
        </div>
    </div>

    <div class="player-container player-c" data-player-id="player-c">
        <div class="player-name-wrapper">
            <div class="player-name editable-name" id="player-c-name" data-player-id="player-c">PLAYER C</div>
        </div>
        <div class="player-frame-score editable-score" id="player-c-frames">0</div>
        <div class="player-score-wrapper">
            <div class="player-score" id="player-c-score">0</div>
        </div>
    </div>

    <div class="control-container">
        <div class="score-buttons-container">
            <div class="score-buttons-row">
                <div class="snooker-ball red" data-score="1">1</div>
                <div class="snooker-ball yellow" data-score="2">2</div>
                <div class="snooker-ball green" data-score="3">3</div>
                <div class="snooker-ball brown" data-score="4">4</div>
            </div>
            <div class="score-buttons-row">
                <div class="snooker-ball blue" data-score="5">5</div>
                <div class="snooker-ball pink" data-score="6">6</div>
                <div class="snooker-ball black" data-score="7">7</div>
                <div class="snooker-ball gold-ball" data-score="10">10</div>
            </div>
        </div>
        <div class="sign-button-container">
            <button class="sign-button" id="minus-button" data-sign="-1">-</button>
        </div>
        <div class="action-buttons-container">
            <button class="action-button finish-button">Finish</button>
            <button class="action-button set-zero-button">Set Zero</button>
            <button class="action-button undo-button">Undo</button>
            <button class="action-button home-button" id="home-button" onclick="window.location.href='index.html';">üè°</button>
            <button class="action-button home-button" id="cg-button">CG</button>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>
    
    <div id="keypad-modal" class="keypad-modal">
        <div class="keypad-container">
            <input type="text" id="keypad-input" class="keypad-input" readonly>
            <div class="keypad-buttons">
                <button class="keypad-button" data-key="1">1</button>
                <button class="keypad-button" data-key="2">2</button>
                <button class="keypad-button" data-key="3">3</button>
                <button class="keypad-button" data-key="4">4</button>
                <button class="keypad-button" data-key="5">5</button>
                <button class="keypad-button" data-key="6">6</button>
                <button class="keypad-button" data-key="7">7</button>
                <button class="keypad-button" data-key="8">8</button>
                <button class="keypad-button" data-key="9">9</button>
                <button class="keypad-button" data-key="0">0</button>
            </div>
            <div class="keypad-buttons-row-special">
                <button class="keypad-button special backspace" data-key="backspace">Backspace</button>
                <button class="keypad-button special done" data-key="done">Done</button>
                <button class="keypad-button special cancel" data-key="cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="name-modal" class="name-modal">
        <div class="name-container">
            <input type="text" id="name-input" class="name-input" maxlength="10" placeholder="Enter Player Name">
            <div class="name-buttons">
                <button class="keypad-button special done" data-key="done">Done</button>
                <button class="keypad-button special cancel" data-key="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let activePlayerId = 'player-a';
        let scoreHistory = [];
        let scoreSign = 1;
        let targetElement = null;
        let backgroundImages = [
            'Background/CothSS.jp',
            'Background/image1.jpg',
            'Background/image2.jpg',
            'Background/image3.jpg',
            'Background/image4.jpg'
        ];
        let currentImageIndex = 0;
        const body = document.body;
        const cgButton = document.getElementById('cg-button');
        
        // Define speech synthesis object
        const synth = window.speechSynthesis;

        // Function to handle speaking
        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            synth.speak(utterance);
        }
        
        // Create a simple audio context for the undo sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playUndoSound() {
            // Create an oscillator node
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            // Set the sound properties (simple digital beep)
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

            // Connect everything
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Start and stop the sound
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
            oscillator.stop(audioContext.currentTime + 0.1);
        }


        // Function to prevent double-tap zoom on mobile devices
        function preventZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.addEventListener('touchmove', function (event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('dblclick', function (event) {
                event.preventDefault();
            }, false);
        }

        function resetScoreSign() {
            const minusButton = document.getElementById('minus-button');
            minusButton.textContent = '-';
            minusButton.classList.remove('active');
            scoreSign = 1;
        }

        window.onload = () => {
            preventZoom();
            resetScoreSign(); // Reset to positive sign on page load
            setupEditableFields(); // New function to handle all editable fields
            setupKeypad();
            setupNameModal();
            setActivePlayer('player-a');
            updateScoreDisplay(document.getElementById('player-a-score'), 0);
            updateScoreDisplay(document.getElementById('player-b-score'), 0);
            updateScoreDisplay(document.getElementById('player-c-score'), 0);
        };

        function updateScoreDisplay(scoreElement, newScore) {
            scoreElement.textContent = newScore;
            // Add/remove class for negative score color
            if (newScore < 0) {
                scoreElement.classList.add('negative-score');
            } else {
                scoreElement.classList.remove('negative-score');
            }
            if (String(newScore).length >= 3) {
                scoreElement.classList.add('three-digit');
            } else {
                scoreElement.classList.remove('three-digit');
            }
        }

        function handleScoreClick(score) {
            const scoreDisplay = document.getElementById(activePlayerId + '-score');
            const playerName = document.getElementById(activePlayerId + '-name').textContent;
            
            const currentScore = parseInt(scoreDisplay.textContent);
            const scoreToAdd = parseInt(score) * scoreSign;
            const newScore = currentScore + scoreToAdd;

            // Record the state before the change
            const snapshot = {};
            document.querySelectorAll('.player-container').forEach(container => {
                const id = container.getAttribute('data-player-id');
                snapshot[id] = {
                    score: parseInt(document.getElementById(id + '-score').textContent),
                    frames: parseInt(document.getElementById(id + '-frames').textContent)
                };
            });
            scoreHistory.push({ type: 'score', snapshot, playerId: activePlayerId, addedScore: scoreToAdd });

            // Speak the point value and the player's name
            if (scoreSign === 1) {
                speak(`${score} point. ${playerName}.`);
            } else {
                speak(`Minus ${score} points. ${playerName}.`);
            }
            
            // Update the score display after a short delay
            setTimeout(() => {
                updateScoreDisplay(scoreDisplay, newScore);
                
                // Speak the new total score after another delay
                setTimeout(() => {
                    if (newScore < 0) {
                        speak(`Minus ${Math.abs(newScore)}`);
                    } else {
                        speak(`${newScore}`);
                    }
                }, 500); // Delay for new total score
            }, 500); // Delay for new total score
        }

        // When clicking player-container (not on editable fields), set active + speak name
        document.querySelectorAll('.player-container').forEach(container => {
            container.addEventListener('click', (e) => {
                // Check if the click is on the main player-container or the big score display
                if (e.target.closest('.editable-score') || e.target.closest('.editable-name')) {
                    return; // do not interfere with editing
                }
                const playerId = container.getAttribute('data-player-id');
                const playerName = document.getElementById(playerId + '-name').textContent;
                
                setActivePlayer(playerId);
                speak(playerName);
                
                // Reset the score sign to positive whenever a player is selected
                resetScoreSign();
            });
        });

        document.querySelectorAll('.snooker-ball').forEach(button => {
            button.addEventListener('click', () => {
                const score = button.getAttribute('data-score');
                if (score) { 
                    handleScoreClick(score);
                }
            });
        });

        document.querySelector('.undo-button').onclick = () => {
            playUndoSound();
            if (scoreHistory.length > 0) {
                const lastMove = scoreHistory.pop();
                const snapshot = lastMove.snapshot;
                
                document.querySelectorAll('.player-container').forEach(container => {
                    const id = container.getAttribute('data-player-id');
                    const scoreEl = document.getElementById(id + '-score');
                    const frameEl = document.getElementById(id + '-frames');

                    if (snapshot[id]) {
                        updateScoreDisplay(scoreEl, snapshot[id].score);
                        frameEl.textContent = snapshot[id].frames;
                    }
                });

                showMessage("Undo complete!", 2000);
            } else {
                showMessage("No moves to undo.", 2000);
            }
            resetScoreSign();
        };

        document.querySelector('.set-zero-button').onclick = () => {
            // Record the state before setting to zero
            const snapshot = {};
            document.querySelectorAll('.player-container').forEach(container => {
                const id = container.getAttribute('data-player-id');
                snapshot[id] = {
                    score: parseInt(document.getElementById(id + '-score').textContent),
                    frames: parseInt(document.getElementById(id + '-frames').textContent)
                };
            });
            scoreHistory.push({ type: 'setZero', snapshot });
            
            document.querySelectorAll('.player-score').forEach(el => updateScoreDisplay(el, 0));
            
            showMessage("All scores reset to zero.", 2000);
            resetScoreSign();
        };

        document.querySelector('.finish-button').onclick = () => {
            // Record the state before finishing the frame
            const snapshot = {};
            document.querySelectorAll('.player-container').forEach(container => {
                const id = container.getAttribute('data-player-id');
                snapshot[id] = {
                    score: parseInt(document.getElementById(id + '-score').textContent),
                    frames: parseInt(document.getElementById(id + '-frames').textContent)
                };
            });
            scoreHistory.push({ type: 'finish', snapshot });

            const scores = {};
            document.querySelectorAll('.player-score').forEach(el => {
                scores[el.id.replace('-score', '')] = parseInt(el.textContent);
            });
            
            const uniqueScores = [...new Set(Object.values(scores))].sort((a,b) => b-a);
            
            if (uniqueScores.length > 1) {
                const maxScore = uniqueScores[0];
                const winningPlayers = Object.keys(scores).filter(playerId => scores[playerId] === maxScore);
                
                if (winningPlayers.length === 1) {
                    const winnerId = winningPlayers[0];
                    const winnerName = document.getElementById(winnerId + '-name').textContent;
                    const frameElement = document.getElementById(winnerId + '-frames');
                    const oldFrameScore = parseInt(frameElement.textContent);
                    frameElement.textContent = oldFrameScore + 1;
                    speak(`${winnerName} wins the frame.`);
                } else {
                    // Check if the current active player has the highest score
                    const lastActivePlayerScore = scores[activePlayerId];
                    if (lastActivePlayerScore === maxScore) {
                        const winnerId = activePlayerId;
                        const winnerName = document.getElementById(winnerId + '-name').textContent;
                        const frameElement = document.getElementById(winnerId + '-frames');
                        const oldFrameScore = parseInt(frameElement.textContent);
                        frameElement.textContent = oldFrameScore + 1;
                        speak(`${winnerName} wins the frame.`);
                    } else {
                        showMessage("It's a draw! No one gets a point.", 3000);
                        speak("It's a draw. No one gets a point.");
                    }
                }
            } else {
                showMessage("It's a draw! No one gets a point.", 3000);
                speak("It's a draw. No one gets a point.");
            }

            document.querySelectorAll('.player-score').forEach(el => updateScoreDisplay(el, 0));
            resetScoreSign();
        };
        
        // Toggle sign when minus button is clicked
        document.getElementById('minus-button').addEventListener('click', (e) => {
            const minusButton = e.target;
            if (scoreSign === 1) {
                scoreSign = -1;
                minusButton.classList.add('active');
                speak("Foul");
            } else {
                scoreSign = 1;
                minusButton.classList.remove('active');
            }
        });

        function setActivePlayer(playerId) {
            document.querySelectorAll('.player-container').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.player-container[data-player-id="${playerId}"]`).classList.add('active');
            activePlayerId = playerId;
        }
        
        function setupEditableFields() {
            // For frame scores (open keypad)
            document.querySelectorAll('.player-frame-score').forEach(scoreEl => {
                scoreEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const parentContainer = scoreEl.closest('.player-container');
                    const newActivePlayerId = parentContainer.getAttribute('data-player-id');
                    setActivePlayer(newActivePlayerId);
                    
                    targetElement = scoreEl;
                    showKeypad(parseInt(scoreEl.textContent));
                });
            });
            
            // For Names (open name modal)
            document.querySelectorAll('.editable-name').forEach(nameEl => {
                nameEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const parentContainer = nameEl.closest('.player-container');
                    const newActivePlayerId = parentContainer.getAttribute('data-player-id');
                    setActivePlayer(newActivePlayerId);

                    targetElement = nameEl;
                    showNameModal(nameEl.textContent);
                });
            });
            
            // Ensure main big scores don't open keypad
            document.querySelectorAll('.player-score').forEach(scoreEl => {
                scoreEl.classList.remove('editable-score');
            });
        }
        
        // Keypad Functions
        function showKeypad(currentValue) {
            const modal = document.getElementById('keypad-modal');
            const input = document.getElementById('keypad-input');
            input.value = currentValue;
            modal.style.display = 'flex';
        }

        function hideKeypad() {
            const modal = document.getElementById('keypad-modal');
            modal.style.display = 'none';
            targetElement = null;
        }

        function setupKeypad() {
            const input = document.getElementById('keypad-input');
            document.querySelectorAll('#keypad-modal .keypad-button[data-key]').forEach(button => {
                button.addEventListener('click', () => {
                    const key = button.getAttribute('data-key');
                    if (key >= '0' && key <= '9') {
                        if (input.value === '0') {
                            input.value = key;
                        } else {
                            input.value += key;
                        }
                    } else if (key === 'backspace') {
                        input.value = input.value.slice(0, -1) || '0';
                    } else if (key === 'done') {
                        const newScore = parseInt(input.value);
                        if (!isNaN(newScore)) {
                            updateScoreDisplay(targetElement, newScore);
                            showMessage("Score updated!", 2000);
                        }
                        hideKeypad();
                    } else if (key === 'cancel') {
                        hideKeypad();
                    }
                });
            });
        }
        
        // Name Modal Functions
        function showNameModal(currentName) {
            const modal = document.getElementById('name-modal');
            const input = document.getElementById('name-input');
            input.value = currentName;
            modal.style.display = 'flex';
            input.focus();
        }

        function hideNameModal() {
            const modal = document.getElementById('name-modal');
            modal.style.display = 'none';
            targetElement = null;
        }

        function setupNameModal() {
            const doneButton = document.querySelector('#name-modal .done');
            const cancelButton = document.querySelector('#name-modal .cancel');
            const input = document.getElementById('name-input');

            doneButton.addEventListener('click', () => {
                if (targetElement) {
                    const newName = input.value.trim().toUpperCase() || 'PLAYER';
                    targetElement.textContent = newName;
                    hideNameModal();
                }
            });
            
            cancelButton.addEventListener('click', () => {
                hideNameModal();
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    doneButton.click();
                }
            });
        }
        
        setActivePlayer('player-a');
        
        function showMessage(message, duration) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        function changeBackground() {
            // Reset to green background if all images have been shown
            if (currentImageIndex >= backgroundImages.length) {
                body.style.backgroundImage = 'none';
                body.style.backgroundColor = '#006400';
                body.classList.remove('darken-background');
                currentImageIndex = 0; // Reset index to loop again
                return;
            }

            const imageUrl = backgroundImages[currentImageIndex];
            const img = new Image();

            img.onload = () => {
                body.style.backgroundImage = `url(${imageUrl})`;
                const needsDarkening = imageUrl.includes('image');
                
                if (needsDarkening) {
                    body.classList.add('darken-background');
                } else {
                    body.classList.remove('darken-background');
                }
                
                currentImageIndex++;
            };
            
            img.onerror = () => {
                console.error(`Failed to load image: ${imageUrl}`);
                showMessage("Failed to load image. Trying the next one...", 3000);
                
                currentImageIndex++;
                changeBackground();
            };
            
            img.src = imageUrl;
        }

        cgButton.addEventListener('click', () => {
            changeBackground();
        });
    </script>
</body>
</html>
